// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & IDENTITY DOMAIN
// ============================================

model User {
  id           String    @id @default(uuid())
  phoneNumber  String    @unique @map("phone_number")
  email        String?   @unique
  username     String    @unique
  name         String? // Real name from OAuth provider (can be duplicate)
  displayName  String    @unique @map("display_name") // Unique identifier shown in games
  passwordHash String?   @map("password_hash") // Optional for OAuth users
  isVerified   Boolean   @default(false) @map("is_verified")
  country      String?   @default("TZ")
  region       String?
  createdAt    DateTime  @default(now()) @map("created_at")
  lastLoginAt  DateTime? @map("last_login_at")

  // OAuth fields
  googleId      String? @unique @map("google_id")
  oauthProvider String? @map("oauth_provider") // 'google', 'facebook', etc.

  gamesAsWhite        Game[]               @relation("WhitePlayer")
  gamesAsBlack        Game[]               @relation("BlackPlayer")
  rating              Rating?
  refreshTokens       RefreshToken[]
  verificationTokens  VerificationToken[]
  passwordResetTokens PasswordResetToken[]
  otpCodes            OtpCode[]

  @@map("users")
}

// ============================================
// RATING (ELO/ILO System)
// ============================================

model Rating {
  userId String @id @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  rating      Int      @default(1200)
  gamesPlayed Int      @default(0) @map("games_played")
  lastUpdated DateTime @updatedAt @map("last_updated")

  @@map("ratings")
}

// ============================================
// AUTHENTICATION TOKENS
// ============================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model VerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model OtpCode {
  id          String   @id @default(uuid())
  phoneNumber String   @map("phone_number")
  userId      String?  @map("user_id")
  code        String
  expiresAt   DateTime @map("expires_at")
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@index([userId])
  @@map("otp_codes")
}

// ============================================
// GAME DOMAIN (Aggregate Root)
// ============================================

model Game {
  id          String     @id @default(uuid())
  status      GameStatus @default(WAITING)
  gameType    GameType   @map("game_type")
  ruleVersion String     @default("TZ-8x8-v1") @map("rule_version")

  whitePlayerId String  @map("white_player_id")
  blackPlayerId String? @map("black_player_id")
  whitePlayer   User    @relation("WhitePlayer", fields: [whitePlayerId], references: [id])
  blackPlayer   User?   @relation("BlackPlayer", fields: [blackPlayerId], references: [id])

  whiteElo Int? @map("white_elo")
  blackElo Int? @map("black_elo")
  aiLevel  Int? @map("ai_level")

  winner    Winner?    @map("winner")
  endReason EndReason? @map("end_reason")

  createdAt DateTime  @default(now()) @map("created_at")
  startedAt DateTime? @map("started_at")
  endedAt   DateTime? @map("ended_at")

  moves Move[]
  clock Clock?

  @@map("games")
}

// ============================================
// GAME ENUMS
// ============================================

enum GameStatus {
  WAITING
  ACTIVE
  FINISHED
  ABORTED
}

enum GameType {
  RANKED
  CASUAL
  AI
}

enum Winner {
  WHITE
  BLACK
  DRAW
}

enum EndReason {
  CHECKMATE
  RESIGN
  TIME
  DISCONNECT
  DRAW
}

// ============================================
// MOVES DOMAIN (Immutable, Append-Only)
// ============================================

model Move {
  id     String @id @default(uuid())
  gameId String @map("game_id")
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)

  moveNumber Int    @map("move_number")
  player     Player

  fromSquare      Int   @map("from_square") // 1-32 (dark squares only)
  toSquare        Int   @map("to_square")
  capturedSquares Int[] @map("captured_squares") // Ordered list for multi-capture

  isPromotion    Boolean @default(false) @map("is_promotion")
  isMultiCapture Boolean @default(false) @map("is_multi_capture")

  notation   String @map("notation") // e.g., "22x17x10"
  engineEval Int?   @map("engine_eval") // Centipawn equivalent

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([gameId, moveNumber])
  @@map("moves")
}

enum Player {
  WHITE
  BLACK
}

// ============================================
// CLOCK DOMAIN (Time Control)
// ============================================

model Clock {
  gameId String @id @map("game_id")
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)

  whiteTimeMs BigInt   @map("white_time_ms")
  blackTimeMs BigInt   @map("black_time_ms")
  lastMoveAt  DateTime @map("last_move_at")

  @@map("clocks")
}
