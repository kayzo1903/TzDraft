// ============================================
// USER & IDENTITY DOMAIN
// ============================================

model User {
    id           String    @id @default(uuid())
    phoneNumber  String    @unique @map("phone_number")
    email        String?   @unique
    username     String    @unique
    name         String? // Real name from OAuth provider (can be duplicate)
    displayName  String    @unique @map("display_name") // Unique identifier shown in games
    passwordHash String?   @map("password_hash") // Optional for OAuth users
    isVerified   Boolean   @default(false) @map("is_verified")
    country      String?   @default("TZ")
    region       String?
    createdAt    DateTime  @default(now()) @map("created_at")
    lastLoginAt  DateTime? @map("last_login_at")

    // OAuth fields
    googleId      String? @unique @map("google_id")
    oauthProvider String? @map("oauth_provider") // 'google', 'facebook', etc.

    gamesAsWhite        Game[]               @relation("WhitePlayer")
    gamesAsBlack        Game[]               @relation("BlackPlayer")
    rating              Rating?
    refreshTokens       RefreshToken[]
    verificationTokens  VerificationToken[]
    passwordResetTokens PasswordResetToken[]
    otpCodes            OtpCode[]

    @@map("users")
}

// ============================================
// RATING (ELO/ILO System)
// ============================================

model Rating {
    userId String @id @map("user_id")
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    rating      Int      @default(1200)
    gamesPlayed Int      @default(0) @map("games_played")
    lastUpdated DateTime @updatedAt @map("last_updated")

    @@map("ratings")
}

// ============================================
// AUTHENTICATION TOKENS
// ============================================

model RefreshToken {
    id        String   @id @default(uuid())
    userId    String   @map("user_id")
    token     String   @unique
    expiresAt DateTime @map("expires_at")
    createdAt DateTime @default(now()) @map("created_at")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@map("refresh_tokens")
}

model VerificationToken {
    id        String   @id @default(uuid())
    userId    String   @map("user_id")
    token     String   @unique
    expiresAt DateTime @map("expires_at")
    createdAt DateTime @default(now()) @map("created_at")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@map("verification_tokens")
}

model PasswordResetToken {
    id        String   @id @default(uuid())
    userId    String   @map("user_id")
    token     String   @unique
    expiresAt DateTime @map("expires_at")
    createdAt DateTime @default(now()) @map("created_at")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@map("password_reset_tokens")
}

model OtpCode {
    id          String   @id @default(uuid())
    phoneNumber String   @map("phone_number")
    userId      String?  @map("user_id")
    code        String
    expiresAt   DateTime @map("expires_at")
    verified    Boolean  @default(false)
    createdAt   DateTime @default(now()) @map("created_at")

    user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([phoneNumber])
    @@index([userId])
    @@map("otp_codes")
}
