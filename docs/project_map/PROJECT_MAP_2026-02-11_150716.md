# TzDraft Project Map (Snapshot)

Snapshot taken: 2026-02-11 15:07:16

This file is a dated snapshot. The canonical project map is:
- `docs/project_map/PROJECT_MAP.md`

---

# TzDraft Project Map

TzDraft is a Tanzania Drafti (8x8) online gaming platform (Next.js frontend + NestJS backend).

Last updated: 2026-02-11 15:07:16

Recommended production domains:
- Frontend: `https://tzdraft.co.tz`
- API: `https://api.tzdraft.co.tz`

## Quick Links

- OAuth cookie flow + Vercel deployment: `docs/Auth_system/oauth2-cookie-vercel-deploy.md`
- OAuth/JWT implementation guide: `docs/Auth_system/oauth2-jwt-implementation-guide.md`
- API endpoint reference: `docs/api/api_endpoints.md`

## Architecture

High-level data flow:

```text
Browser (Next.js)
  |
  | HTTPS (REST) + WebSocket
  v
API (NestJS)
  |
  | Prisma
  v
Database (PostgreSQL)
```

Runtime channels:
- REST: auth, games, moves, support
- OAuth: Google redirect to backend callback, then redirect to frontend finisher
- WebSocket: real-time game updates (Socket.IO gateway)

## Repo Layout

```text
TzDraft/
  backend/       NestJS API (REST + WebSocket)
  frontend/      Next.js app (App Router, i18n)
  packages/      Shared packages (cake-engine)
  docs/          Documentation
```

Servers (development):
- Frontend: `http://localhost:3000`
- Backend: `http://localhost:3002`

## Backend Map (`backend/`)

Tech stack:
- NestJS 11
- Passport: JWT + Google OAuth
- Prisma (schema split into modular files)
- Socket.IO gateway for real-time messaging

Entrypoints:
- App bootstrap: `backend/src/main.ts`
- Root module: `backend/src/app.module.ts`

Auth module (current):
- Controller: `backend/src/auth/auth.controller.ts`
- Service: `backend/src/auth/auth.service.ts`
- OTP service: `backend/src/auth/otp.service.ts`
- Strategies: `backend/src/auth/strategies/google.strategy.ts`, `backend/src/auth/strategies/jwt.strategy.ts`
- Guards: `backend/src/auth/guards/google-oauth.guard.ts`, `backend/src/auth/guards/jwt-auth.guard.ts`, `backend/src/auth/guards/ws-jwt.guard.ts`

HTTP API module:
- Module: `backend/src/interface/http/http.module.ts`
- Controllers: `backend/src/interface/http/controllers/game.controller.ts`, `backend/src/interface/http/controllers/move.controller.ts`, `backend/src/interface/http/controllers/support.controller.ts`

Application layer (use-cases):
- `backend/src/application/use-cases/create-game.use-case.ts`
- `backend/src/application/use-cases/make-move.use-case.ts`
- `backend/src/application/use-cases/get-game-state.use-case.ts`
- `backend/src/application/use-cases/get-legal-moves.use-case.ts`
- `backend/src/application/use-cases/end-game.use-case.ts`

Domain layer (selected):
- Game domain: `backend/src/domain/game/` (entities, rules, services, value-objects)
- User domain: `backend/src/domain/user/` (entities, value-objects)

Infrastructure layer (selected):
- Database/Prisma: `backend/src/infrastructure/database/`
- Repositories: `backend/src/infrastructure/repositories/`
- Messaging gateway: `backend/src/infrastructure/messaging/games.gateway.ts`
- SMS integration: `backend/src/infrastructure/sms/`

Prisma:
- Root schema: `backend/prisma/schema.prisma`
- Modular schemas: `backend/prisma/schema/*.prisma`
- Migrations: `backend/prisma/migrations/*`

## Frontend Map (`frontend/`)

Tech stack:
- Next.js 16 (App Router)
- React 19
- Tailwind CSS 4
- `next-intl` for i18n

Env vars (frontend runtime):
- `NEXT_PUBLIC_API_URL` (defaults to `http://localhost:3002`)
- `NEXT_PUBLIC_SITE_URL` (defaults to `http://localhost:3000`)

Routes (selected):
- Login: `frontend/src/app/[locale]/auth/login/page.tsx`
- Signup: `frontend/src/app/[locale]/auth/signup/page.tsx`
- OAuth finisher: `frontend/src/app/[locale]/auth/oauth-callback/page.tsx`
- Profile: `frontend/src/app/[locale]/profile/page.tsx`
- Settings: `frontend/src/app/[locale]/settings/page.tsx`
- Support: `frontend/src/app/[locale]/support/page.tsx`

Networking:
- Axios: `frontend/src/lib/axios.ts`
- Socket: `frontend/src/hooks/useSocket.ts`

Key components (selected):
- Navbar: `frontend/src/components/layout/Navbar.tsx`

i18n messages:
- `frontend/messages/en.json`
- `frontend/messages/sw.json`

## Auth Behavior (Current)

Primary methods:
- Username/phone + password login: `POST /auth/login`
- Phone OTP: `POST /auth/send-otp`, `POST /auth/verify-otp` (OTP includes a `purpose`)
- Google OAuth2: `GET /auth/google`, `GET /auth/google/callback`

Production-friendly OAuth UX:
- Backend callback sets `httpOnly` cookies (`accessToken`, `refreshToken`) and redirects to frontend without tokens in URL.
- Frontend finishes by calling `POST /auth/refresh` (cookie-based) then `GET /auth/me`.
- OAuth failures redirect to `FRONTEND_URL/auth/login?error=google_failed`.

Phone verification policy:
- Users with a real registered Tanzania phone number (`+255...`) are treated as verified and get a verification badge in the UI.
- Users with no phone number (including OAuth users without a real phone) are not verified.

## Database Models (Prisma)

Primary models (from `backend/prisma/schema.prisma`):
- `User`, `Rating`
- `RefreshToken`
- `VerificationToken`, `PasswordResetToken`
- `OtpCode`
- `Game`, `Move`, `Clock`

## Environment Variables

Backend (development baseline):
- `FRONTEND_URL=http://localhost:3000`
- `CORS_ORIGIN=http://localhost:3000`

Backend (production baseline for `tzdraft.co.tz`):
- `FRONTEND_URL=https://tzdraft.co.tz`
- `CORS_ORIGIN=https://tzdraft.co.tz`
- `COOKIE_DOMAIN=.tzdraft.co.tz`
- `GOOGLE_CLIENT_ID=...apps.googleusercontent.com`
- `GOOGLE_CLIENT_SECRET=GOCSPX-...`

Frontend (Vercel):
- `NEXT_PUBLIC_API_URL=https://api.tzdraft.co.tz`
- `NEXT_PUBLIC_SITE_URL=https://tzdraft.co.tz`

## Commands

Frontend (run from inside `frontend/` so Tailwind resolves correctly):
```bash
pnpm -C frontend dev
pnpm -C frontend build
pnpm -C frontend start
```

Backend:
```bash
pnpm -C backend start:dev
pnpm -C backend build
```

Prisma (backend):
```bash
pnpm -C backend prisma:generate
```

## Documentation Index

Auth docs:
- `docs/Auth_system/oauth2-cookie-vercel-deploy.md`
- `docs/Auth_system/oauth2-jwt-implementation-guide.md`

API docs:
- `docs/api/api_endpoints.md`
- `docs/api/postman_quick_start.md`
- `docs/api/postman_test_scripts.md`
- `docs/api/test_scenarios.md`
- `docs/api/troubleshooting.md`

Project maps:
- Canonical: `docs/project_map/PROJECT_MAP.md`
- Snapshot (example): `docs/project_map/PROJECT_MAP_2026-02-11_150716.md`

## Development Status (Snapshot)

Completed (recent):
- Game-themed auth pages (signup + login) + password toggle
- OTP flow supports `purpose` (signup/password reset/verify phone)
- Phone verification badge policy (+255 considered verified)
- Google OAuth cookie redirect flow + Vercel deployment documentation
- Profile and settings pages with i18n keys

In progress:
- More route protection + auth hardening (middleware/guards consistency)
- Game flow polish and realtime sync improvements

Planned:
- Matchmaking, ratings/ELO, history/replay, tournaments, admin tooling
- Stronger production security posture (CSRF strategy if moving to full cookie auth)

## Repo Statistics

Counts (approx):
- Backend TS files (under `backend/src`): 62
- Frontend TS/TSX files (under `frontend/src`): 65
- Docs markdown files (under `docs/`): 37

